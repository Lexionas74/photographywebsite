<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Stuart Clarkson Photography</title>

  <!-- Tailwind + Supabase JS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: "Poppins", sans-serif;
    }
  </style>
</head>

<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- MAIN WRAPPER -->
  <div class="flex-1 p-6">

    <!-- LOGIN -->
    <div id="loginSection" class="text-center max-w-lg mx-auto mt-10">
      <h1 class="text-3xl font-bold mb-4">Admin Login</h1>

      <input
        id="passwordInput"
        type="password"
        class="px-4 py-2 text-black rounded-lg w-64"
        placeholder="Enter admin password"
      />

      <button
        id="loginButton"
        class="ml-3 bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700 transition"
      >
        Login
      </button>

      <p
        id="loginError"
        class="text-red-400 mt-3 hidden"
      >
        Incorrect password. Please try again.
      </p>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="hidden">

      <!-- UPLOAD CARD -->
      <div class="max-w-xl mx-auto bg-gray-800 mt-10 p-6 rounded-xl shadow-xl">
        <h2 class="text-2xl font-bold mb-4">Upload Image</h2>

        <form id="uploadForm" class="space-y-4">

          <!-- NEW: Gallery dropdown + manual gallery -->
          <div>
            <label class="block mb-1 font-semibold">Select Existing Gallery</label>
            <select id="galleryDropdown"
              class="w-full px-4 py-2 rounded-lg text-black bg-white">
              <option value="">Loading galleries...</option>
            </select>
          </div>

          <div class="mt-3">
            <label class="block mb-1 font-semibold">Or Create New Gallery</label>
            <input id="galleryInput" type="text"
              class="w-full px-4 py-2 rounded-lg text-black"
              placeholder="e.g. gtwc2025 (optional)">
          </div>

          <div>
            <label class="block mb-1">Title</label>
            <input
              id="titleInput"
              type="text"
              class="w-full px-4 py-2 rounded-lg text-black"
              placeholder="Optional"
            />
          </div>

          <div>
            <label class="block mb-1">Select Image</label>
            <input id="fileInput" type="file" accept="image/*" required />
          </div>

          <button
            class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg w-full"
          >
            Upload
          </button>
        </form>

        <!-- UPLOAD PREVIEW -->
        <div id="previewSection" class="hidden text-center mt-6">
          <p class="text-lg font-semibold">Upload Successful!</p>
          <img
            id="previewImage"
            class="mt-3 rounded-xl max-h-96 mx-auto shadow-xl"
          />
          <p
            id="imageUrl"
            class="mt-2 break-all text-purple-400 text-sm"
          ></p>
        </div>
      </div>

      <!-- DELETE PANEL -->
      <div class="max-w-5xl mx-auto bg-gray-800 mt-14 p-6 rounded-xl shadow-xl">
        <h2 class="text-3xl font-bold mb-6 text-center">Delete Images</h2>

        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm md:text-base">
            <thead>
              <tr class="border-b border-gray-700">
                <th class="p-2">ID</th>
                <th class="p-2">Gallery</th>
                <th class="p-2">Title</th>
                <th class="p-2">Preview</th>
                <th class="p-2">Delete</th>
              </tr>
            </thead>
            <tbody id="deleteTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="bg-gray-800 text-center py-4 mt-10">
    <p class="text-sm text-gray-400">
      &copy; 2025 Stuart Clarkson Photography. Admin Panel.
    </p>
  </footer>

  <!-- SCRIPT -->
  <script>
    /************************************************
     * CONFIG
     ***********************************************/
    const SUPABASE_URL = "https://ygnfuztbwsngjihrinlr.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlnbmZ1enRid3NuZ2ppaHJpbmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5ODUwOTMsImV4cCI6MjA3ODU2MTA5M30.YlKPGDE3hfF9mOIVbUEQQFtN8gwt6L0MOYldH1AOMGw";

    const LOGIN_FUNCTION_URL =
      "https://ygnfuztbwsngjihrinlr.functions.supabase.co/login";
    const UPLOAD_FUNCTION_URL =
      "https://ygnfuztbwsngjihrinlr.functions.supabase.co/upload";
    const DELETE_FUNCTION_URL =
      "https://ygnfuztbwsngjihrinlr.functions.supabase.co/delete";

    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    /************************************************
     * LOAD GALLERIES INTO DROPDOWN
     ***********************************************/
    async function loadGalleryList() {
      const dropdown = document.getElementById("galleryDropdown");
      dropdown.innerHTML = `<option>Loading...</option>`;

      const { data, error } = await supabase
        .from("images")
        .select("gallery")
        .order("gallery", { ascending: true });

      if (error) {
        console.error("Error loading galleries:", error);
        dropdown.innerHTML = `<option value="">Error loading galleries</option>`;
        return;
      }

      // Unique gallery names
      const unique = [...new Set(data.map(x => x.gallery).filter(Boolean))];

      if (unique.length === 0) {
        dropdown.innerHTML = `<option value="">No galleries yet</option>`;
        return;
      }

      dropdown.innerHTML = `<option value="">-- Select gallery --</option>`;

      unique.forEach(g => {
        dropdown.innerHTML += `<option value="${g}">${g}</option>`;
      });

      dropdown.innerHTML += `<option value="__new__">âž• Create New Gallery</option>`;
    }

    /************************************************
     * LOGIN HANDLER
     ***********************************************/
    const loginButton = document.getElementById("loginButton");
    const passwordInput = document.getElementById("passwordInput");
    const loginError = document.getElementById("loginError");
    const loginSection = document.getElementById("loginSection");
    const adminPanel = document.getElementById("adminPanel");

    loginButton.addEventListener("click", doLogin);
    passwordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") doLogin();
    });

    async function doLogin() {
      const pass = passwordInput.value.trim();

      // Hide previous error
      loginError.classList.add("hidden");

      if (!pass) {
        loginError.textContent = "Please enter the admin password.";
        loginError.classList.remove("hidden");
        return;
      }

      try {
        const res = await fetch(LOGIN_FUNCTION_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`, // required by platform
          },
          body: JSON.stringify({ password: pass }),
        });

        const data = await res.json();
        console.log("Login response:", data);

        if (!data || !data.success) {
          loginError.textContent = data?.error || "Incorrect password.";
          loginError.classList.remove("hidden");
          return;
        }

        // SUCCESS
        loginSection.classList.add("hidden");
        adminPanel.classList.remove("hidden");
        loginError.classList.add("hidden");

        // ðŸ”¹ Load galleries + images once logged in
        await loadGalleryList();
        await loadDeleteTable();
      } catch (err) {
        console.error("Login error:", err);
        loginError.textContent = "Network error. Please try again.";
        loginError.classList.remove("hidden");
      }
    }

    /************************************************
     * UPLOAD HANDLER
     ***********************************************/
    const uploadForm = document.getElementById("uploadForm");
    const galleryInput = document.getElementById("galleryInput");
    const titleInput = document.getElementById("titleInput");
    const fileInput = document.getElementById("fileInput");
    const previewSection = document.getElementById("previewSection");
    const previewImage = document.getElementById("previewImage");
    const imageUrlEl = document.getElementById("imageUrl");
    const galleryDropdown = document.getElementById("galleryDropdown");

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      // âœ… New gallery selection logic
      let gallery = galleryDropdown.value;
      const manualGallery = galleryInput.value.trim();

      if (gallery === "__new__" && manualGallery) {
        gallery = manualGallery;
      }

      if (!gallery) {
        alert("Please select a gallery or enter a new gallery name.");
        return;
      }

      const title = titleInput.value.trim();
      const file = fileInput.files[0];

      if (!file) {
        alert("Please choose an image.");
        return;
      }


      const formData = new FormData();
      formData.append("gallery", gallery);
      formData.append("title", title);
      formData.append("image", file);


      try {
        const res = await fetch(UPLOAD_FUNCTION_URL, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`, // DO NOT set Content-Type with FormData
          },
          body: formData,
        });

        const data = await res.json();
        console.log("Upload response:", data);

        if (!res.ok || !data.success) {
          alert("Upload failed: " + (data.error || "Unknown error"));
          return;
        }

        // Show preview
        previewSection.classList.remove("hidden");
        previewImage.src = data.url;
        imageUrlEl.textContent = data.url;

        // Clear file input
        fileInput.value = "";
        titleInput.value = "";

        // Reload table (and dropdown if new gallery was created)
        await loadDeleteTable();
        await loadGalleryList();
      } catch (err) {
        console.error("Upload error:", err);
        alert("Upload failed due to network error.");
      }
    });

    /************************************************
     * LOAD DELETE TABLE
     ***********************************************/
    async function loadDeleteTable() {
      console.log("Loading delete table...");
      const { data: images, error } = await supabase
        .from("images")
        .select("*")
        .order("sort_order", { ascending: true });

      if (error) {
        console.error("Error loading images:", error);
        return;
      }

      const tbody = document.getElementById("deleteTable");
      tbody.innerHTML = "";

      if (!images || images.length === 0) {
        const emptyRow = document.createElement("tr");
        emptyRow.innerHTML =
          '<td colspan="5" class="p-4 text-center text-gray-400">No images found.</td>';
        tbody.appendChild(emptyRow);
        return;
      }

      images.forEach((img) => {
        const storagePath = img.image_url.split("/object/public/images/")[1];

        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-700";

        tr.innerHTML = `
          <td class="p-2">${img.id}</td>
          <td class="p-2">${img.gallery}</td>
          <td class="p-2">${img.title || ""}</td>
          <td class="p-2">
            <img src="${img.image_url}" class="h-16 w-auto rounded object-cover" />
          </td>
          <td class="p-2">
            <button
              class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm"
              data-id="${img.id}"
              data-path="${storagePath}"
            >
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(tr);
      });

      // Wire delete buttons
      tbody.querySelectorAll("button[data-id]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = parseInt(btn.getAttribute("data-id"), 10);
          const path = btn.getAttribute("data-path");
          deleteImage(id, path);
        });
      });
    }

    /************************************************
     * DELETE IMAGE
     ***********************************************/
    async function deleteImage(id, storagePath) {
      if (!confirm("Delete this image permanently?")) return;

      const adminPassword = prompt("Enter admin password to delete:");
      if (!adminPassword) return;

      try {
        const res = await fetch(DELETE_FUNCTION_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
          },
          body: JSON.stringify({
            id,
            storagePath,
            admin_password: adminPassword,
          }),
        });

        const data = await res.json();
        console.log("Delete response:", data);

        if (!res.ok || !data.success) {
          alert("Delete failed: " + (data.error || "Unknown error"));
          return;
        }

        alert("Image deleted.");
        await loadDeleteTable();
        await loadGalleryList();
      } catch (err) {
        console.error("Delete error:", err);
        alert("Network error while deleting.");
      }
    }
  </script>
</body>
</html>
